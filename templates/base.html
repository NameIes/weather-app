<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Weather App</title>
    <style>
      .wgrid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
      }
      @media (max-width: 768px) {
        .wgrid {
          grid-template-columns: repeat(4, 1fr);
        }
      }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  </head>
  <body>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <div class="container" id="vue-app">
      {% block main %}
      {% endblock main %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      const { createApp } = Vue;

      const api = axios.create({
        baseURL: "http://localhost:8000/api/",
        withCredentials: true,
        xsrfCookieName: "csrftoken",
        xsrfHeaderName: "X-CSRFTOKEN",
      });

      const app = createApp({
        delimiters: ['[[', ']]'],
        data() {
          return {
            search_text: '',
            search_focused: false,
            search_loading: false,
            cities_list: [],
            selected_city: null,
            current: null,
            today: null,
            two_weeks: null,
          }
        },
        methods: {
          on_search() {
            this.search_loading = true;
            if (this.search_text.length < 2) return;
            api.get('search-geo/', {
              params: {
                name: this.search_text,
              }
            }).then((response) => {
              this.cities_list = response.data.results;
            }).catch((err) => {
              console.error(err);
            }).finally(() => {
              this.search_loading = false;
            });
          },
          on_blur() {
            setTimeout(() => {
              this.search_focused = false;
            }, 150);
          },
          getWindDirection(degrees) {
            if (degrees >= 337.5 || degrees < 22.5) {
              return 'N';
            } else if (degrees >= 22.5 && degrees < 67.5) {
              return 'NE';
            } else if (degrees >= 67.5 && degrees < 112.5) {
              return 'E';
            } else if (degrees >= 112.5 && degrees < 157.5) {
              return 'SE';
            } else if (degrees >= 157.5 && degrees < 202.5) {
              return 'S';
            } else if (degrees >= 202.5 && degrees < 247.5) {
              return 'SW';
            } else if (degrees >= 247.5 && degrees < 292.5) {
              return 'W';
            } else if (degrees >= 292.5 && degrees < 337.5) {
              return 'NW';
            }
          },
          parseWeatherCode(w_code, is_day) {
            const data = {
              0:{
                1:{
                  "description":"Sunny",
                  "image":"http://openweathermap.org/img/wn/01d@4x.png"
                },
                0:{
                  "description":"Clear",
                  "image":"http://openweathermap.org/img/wn/01n@4x.png"
                }
              },
              1:{
                1:{
                  "description":"Mainly Sunny",
                  "image":"http://openweathermap.org/img/wn/01d@4x.png"
                },
                0:{
                  "description":"Mainly Clear",
                  "image":"http://openweathermap.org/img/wn/01n@4x.png"
                }
              },
              2:{
                1:{
                  "description":"Partly Cloudy",
                  "image":"http://openweathermap.org/img/wn/02d@4x.png"
                },
                0:{
                  "description":"Partly Cloudy",
                  "image":"http://openweathermap.org/img/wn/02n@4x.png"
                }
              },
              3:{
                1:{
                  "description":"Cloudy",
                  "image":"http://openweathermap.org/img/wn/03d@4x.png"
                },
                0:{
                  "description":"Cloudy",
                  "image":"http://openweathermap.org/img/wn/03n@4x.png"
                }
              },
              45:{
                1:{
                  "description":"Foggy",
                  "image":"http://openweathermap.org/img/wn/50d@4x.png"
                },
                0:{
                  "description":"Foggy",
                  "image":"http://openweathermap.org/img/wn/50n@4x.png"
                }
              },
              48:{
                1:{
                  "description":"Rime Fog",
                  "image":"http://openweathermap.org/img/wn/50d@4x.png"
                },
                0:{
                  "description":"Rime Fog",
                  "image":"http://openweathermap.org/img/wn/50n@4x.png"
                }
              },
              51:{
                1:{
                  "description":"Light Drizzle",
                  "image":"http://openweathermap.org/img/wn/09d@4x.png"
                },
                0:{
                  "description":"Light Drizzle",
                  "image":"http://openweathermap.org/img/wn/09n@4x.png"
                }
              },
              53:{
                1:{
                  "description":"Drizzle",
                  "image":"http://openweathermap.org/img/wn/09d@4x.png"
                },
                0:{
                  "description":"Drizzle",
                  "image":"http://openweathermap.org/img/wn/09n@4x.png"
                }
              },
              55:{
                1:{
                  "description":"Heavy Drizzle",
                  "image":"http://openweathermap.org/img/wn/09d@4x.png"
                },
                0:{
                  "description":"Heavy Drizzle",
                  "image":"http://openweathermap.org/img/wn/09n@4x.png"
                }
              },
              56:{
                1:{
                  "description":"Light Freezing Drizzle",
                  "image":"http://openweathermap.org/img/wn/09d@4x.png"
                },
                0:{
                  "description":"Light Freezing Drizzle",
                  "image":"http://openweathermap.org/img/wn/09n@4x.png"
                }
              },
              57:{
                1:{
                  "description":"Freezing Drizzle",
                  "image":"http://openweathermap.org/img/wn/09d@4x.png"
                },
                0:{
                  "description":"Freezing Drizzle",
                  "image":"http://openweathermap.org/img/wn/09n@4x.png"
                }
              },
              61:{
                1:{
                  "description":"Light Rain",
                  "image":"http://openweathermap.org/img/wn/10d@4x.png"
                },
                0:{
                  "description":"Light Rain",
                  "image":"http://openweathermap.org/img/wn/10n@4x.png"
                }
              },
              63:{
                1:{
                  "description":"Rain",
                  "image":"http://openweathermap.org/img/wn/10d@4x.png"
                },
                0:{
                  "description":"Rain",
                  "image":"http://openweathermap.org/img/wn/10n@4x.png"
                }
              },
              65:{
                1:{
                  "description":"Heavy Rain",
                  "image":"http://openweathermap.org/img/wn/10d@4x.png"
                },
                0:{
                  "description":"Heavy Rain",
                  "image":"http://openweathermap.org/img/wn/10n@4x.png"
                }
              },
              66:{
                1:{
                  "description":"Light Freezing Rain",
                  "image":"http://openweathermap.org/img/wn/10d@4x.png"
                },
                0:{
                  "description":"Light Freezing Rain",
                  "image":"http://openweathermap.org/img/wn/10n@4x.png"
                }
              },
              67:{
                1:{
                  "description":"Freezing Rain",
                  "image":"http://openweathermap.org/img/wn/10d@4x.png"
                },
                0:{
                  "description":"Freezing Rain",
                  "image":"http://openweathermap.org/img/wn/10n@4x.png"
                }
              },
              71:{
                1:{
                  "description":"Light Snow",
                  "image":"http://openweathermap.org/img/wn/13d@4x.png"
                },
                0:{
                  "description":"Light Snow",
                  "image":"http://openweathermap.org/img/wn/13n@4x.png"
                }
              },
              73:{
                1:{
                  "description":"Snow",
                  "image":"http://openweathermap.org/img/wn/13d@4x.png"
                },
                0:{
                  "description":"Snow",
                  "image":"http://openweathermap.org/img/wn/13n@4x.png"
                }
              },
              75:{
                1:{
                  "description":"Heavy Snow",
                  "image":"http://openweathermap.org/img/wn/13d@4x.png"
                },
                0:{
                  "description":"Heavy Snow",
                  "image":"http://openweathermap.org/img/wn/13n@4x.png"
                }
              },
              77:{
                1:{
                  "description":"Snow Grains",
                  "image":"http://openweathermap.org/img/wn/13d@4x.png"
                },
                0:{
                  "description":"Snow Grains",
                  "image":"http://openweathermap.org/img/wn/13n@4x.png"
                }
              },
              80:{
                1:{
                  "description":"Light Showers",
                  "image":"http://openweathermap.org/img/wn/09d@4x.png"
                },
                0:{
                  "description":"Light Showers",
                  "image":"http://openweathermap.org/img/wn/09n@4x.png"
                }
              },
              81:{
                1:{
                  "description":"Showers",
                  "image":"http://openweathermap.org/img/wn/09d@4x.png"
                },
                0:{
                  "description":"Showers",
                  "image":"http://openweathermap.org/img/wn/09n@4x.png"
                }
              },
              82:{
                1:{
                  "description":"Heavy Showers",
                  "image":"http://openweathermap.org/img/wn/09d@4x.png"
                },
                0:{
                  "description":"Heavy Showers",
                  "image":"http://openweathermap.org/img/wn/09n@4x.png"
                }
              },
              85:{
                1:{
                  "description":"Light Snow Showers",
                  "image":"http://openweathermap.org/img/wn/13d@4x.png"
                },
                0:{
                  "description":"Light Snow Showers",
                  "image":"http://openweathermap.org/img/wn/13n@4x.png"
                }
              },
              86:{
                1:{
                  "description":"Snow Showers",
                  "image":"http://openweathermap.org/img/wn/13d@4x.png"
                },
                0:{
                  "description":"Snow Showers",
                  "image":"http://openweathermap.org/img/wn/13n@4x.png"
                }
              },
              95:{
                1:{
                  "description":"Thunderstorm",
                  "image":"http://openweathermap.org/img/wn/11d@4x.png"
                },
                0:{
                  "description":"Thunderstorm",
                  "image":"http://openweathermap.org/img/wn/11n@4x.png"
                }
              },
              96:{
                1:{
                  "description":"Light Thunderstorms With Hail",
                  "image":"http://openweathermap.org/img/wn/11d@4x.png"
                },
                0:{
                  "description":"Light Thunderstorms With Hail",
                  "image":"http://openweathermap.org/img/wn/11n@4x.png"
                }
              },
              99:{
                1:{
                  "description":"Thunderstorm With Hail",
                  "image":"http://openweathermap.org/img/wn/11d@4x.png"
                },
                0:{
                  "description":"Thunderstorm With Hail",
                  "image":"http://openweathermap.org/img/wn/11n@4x.png"
                }
              }
            };
            return data[w_code][is_day];
          },
          convertTimeString(timeString) {
            let date = new Date(timeString);
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            let day = date.getDate();
            let monthName = months[date.getMonth()];
            let result = `${day} ${monthName}`;
            return result;
          },
          on_select(city) {
            this.selected_city = city;
            this.search_text = city.name;

            api.get('get-weather/', {
              params: {
                city: JSON.stringify(this.selected_city)
              }
            }).then((response) => {
              const weather = JSON.parse(response.data);
              this.current = weather.current.current;
              this.today = weather.today.hourly;
              this.two_weeks = weather.twoweeks.daily;

              this.current.pressure_msl = Math.floor(this.current.pressure_msl * 0.750062);
              this.current.temperature_2m = Math.floor(this.current.temperature_2m);
              this.current.wind_direction_10m = this.getWindDirection(this.current.wind_direction_10m);
            }).catch((err) => {
              console.error(err);
            });
          }
        }
      });
      app.mount('#vue-app');
    </script>
  </body>
</html>
