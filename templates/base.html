<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Weather App</title>
    <style>
      .wgrid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
      }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  </head>
  <body>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <div class="container" id="vue-app">
      {% block main %}
      {% endblock main %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      const { createApp } = Vue;

      const api = axios.create({
        baseURL: "http://localhost:8000/api/",
        withCredentials: true,
        xsrfCookieName: "csrftoken",
        xsrfHeaderName: "X-CSRFTOKEN",
      });

      const app = createApp({
        delimiters: ['[[', ']]'],
        data() {
          return {
            search_text: '',
            search_focused: false,
            search_loading: false,
            cities_list: [],
            selected_city: null,
            weather: null,
          }
        },
        methods: {
          on_search() {
            this.search_loading = true;
            if (this.search_text.length < 2) return;
            api.get('search-geo/', {
              params: {
                name: this.search_text,
              }
            }).then((response) => {
              this.cities_list = response.data.results;
            }).catch((err) => {
              console.error(err);
            }).finally(() => {
              this.search_loading = false;
            });
          },
          on_blur() {
            setTimeout(() => {
              this.search_focused = false;
            }, 150);
          },
          on_select(city) {
            this.selected_city = city;
            this.search_text = city.name;

            api.get('get-weather/', {
              params: {
                city: JSON.stringify(this.selected_city)
              }
            }).then((response) => {
              console.log(response);
            }).catch((err) => {
              console.error(err);
            });
          }
        }
      });
      app.mount('#vue-app');
    </script>
  </body>
</html>
